name: Build Fork (Linux ARM64 + AMD64)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build Linux ${{ matrix.arch }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        arch: [arm64, amd64]
    steps:
      - name: üì¢ Notify Start
        run: |
          curl \
            -H "Title: Deploy picoclaw Linux ${{ matrix.arch }} Started üöÄ" \
            -H "Tags: rocket,construction_worker" \
            -H "Priority: default" \
            -d "Branch: ${{ github.ref_name }} | Commit: ${{ github.sha }}" \
            https://ntfy.sh/deploy-on-github-xasr6KBz47PjswPf53A78Fib

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        id: setup-go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Determine Fork Version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.2")
          BASE_TAG=$(echo "$LATEST_TAG" | sed -E 's/-fork-[0-9.]+//g')
          FORK_VERSION="${BASE_TAG}-fork-0.${{ github.run_number }}"
          
          echo "Versi fork: $FORK_VERSION"
          echo "FORK_VERSION=$FORK_VERSION" >> $GITHUB_ENV

      - name: Restrict GoReleaser to linux/${{ matrix.arch }}
        run: |
          yq -i '.project_name = "picoclaw"' .goreleaser.yaml
          yq -i '.builds[0].goos = ["linux"]' .goreleaser.yaml
          yq -i '.builds[0].goarch = ["${{ matrix.arch }}"]' .goreleaser.yaml
          yq -i 'del(.builds[0].ignore)' .goreleaser.yaml
          yq -i 'del(.dockers_v2)' .goreleaser.yaml
          yq -i '.snapshot.version_template = "{{ .Env.GORELEASER_CURRENT_TAG }}"' .goreleaser.yaml

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: ~> v2
          args: release --clean --snapshot
        env:
          GOVERSION: ${{ steps.setup-go.outputs.go-version }}
          GORELEASER_CURRENT_TAG: ${{ env.FORK_VERSION }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: picoclaw-linux-${{ matrix.arch }}-${{ env.FORK_VERSION }}
          path: dist/*.tar.gz
          if-no-files-found: warn

      - name: Create or Update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Coba upload ke existing release dulu (lebih aman untuk matrix jobs)
          gh release upload "${{ env.FORK_VERSION }}" dist/*.tar.gz --clobber 2>/dev/null \
          || gh release create "${{ env.FORK_VERSION }}" dist/*.tar.gz \
            --title "Fork Build ${{ env.FORK_VERSION }}" \
            --notes "Automated release from branch ${{ github.ref_name }}."

      - name: üì¢ Notify Success
        if: success()
        run: |
          curl \
            -H "Title: Deploy picoclaw Linux ${{ matrix.arch }} Success ‚úÖ" \
            -H "Tags: white_check_mark,partying_face" \
            -H "Priority: high" \
            -d "Build artifact picoclaw-linux-${{ matrix.arch }}-${{ env.FORK_VERSION }} has been successfully uploaded." \
            https://ntfy.sh/deploy-on-github-xasr6KBz47PjswPf53A78Fib

      - name: üì¢ Notify Failure
        if: failure()
        run: |
          curl \
            -H "Title: Deploy picoclaw Linux ${{ matrix.arch }} Failed ‚ùå" \
            -H "Tags: x,skull" \
            -H "Priority: urgent" \
            -d "Build failed on branch ${{ github.ref_name }}. Please check the GitHub Actions logs." \
            https://ntfy.sh/deploy-on-github-xasr6KBz47PjswPf53A78Fib
